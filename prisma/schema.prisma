generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String       @id @default(cuid())
  name          String?
  email         String?      @unique
  emailVerified Boolean      @default(false)
  image         String?
  walletAddress String?      @unique
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  accounts      Account[]
  investments   Investment[]
  sessions      Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model InvestmentProject {
  id           String        @id @default(cuid())
  name         String
  type         String
  description  String?
  purpose      String
  example      String?
  minAmount    Float         @default(0)
  maxAmount    Float?
  totalAmount  Float         @default(0)
  targetAmount Float
  status       String        @default("active")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  investments  Investment[]
  files        ProjectFile[]
}

model ProjectFile {
  id          String            @id @default(cuid())
  projectId   String
  fileName    String
  filePath    String
  fileType    String
  fileSize    Int
  description String?
  uploadedBy  String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  project     InvestmentProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([createdAt])
}

model Investment {
  id        String            @id @default(cuid())
  userId    String
  projectId String
  amount    Float
  xrpAmount Float?
  txHash    String?           @unique
  status    String            @default("pending")
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  project   InvestmentProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RevPayoutBatch {
  id           String          @id @default(cuid())
  tokenId      String
  stablecoinId String
  network      String
  totalAmount  Float
  memo         String?
  scheduledFor DateTime?
  status       String          @default("scheduled")
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  items        RevPayoutItem[]
}

model RevPayoutItem {
  id            String         @id @default(cuid())
  batchId       String
  holderAddress String
  holderBalance Float
  share         Float
  amount        Float
  status        String         @default("pending")
  attempts      Int            @default(0)
  txHash        String?
  lastError     String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  batch         RevPayoutBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@index([status])
}

model IssuanceRecord {
  id          String   @id @default(cuid())
  projectId   String
  projectName String
  tokenType   String
  currency    String
  amount      String
  decimals    Int
  issuer      String
  network     String
  txHash      String
  metadata    Json     @default("{}")
  rawResponse Json?
  createdAt   DateTime @default(now())

  @@index([projectId])
  @@index([issuer])
  @@index([txHash])
  @@index([createdAt])
}

model ActionRecord {
  id            String   @id @default(cuid())
  type          String
  tokenCurrency String
  tokenIssuer   String
  actor         String
  target        String?
  amount        String?
  network       String
  txHash        String
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now())

  @@index([type])
  @@index([actor])
  @@index([txHash])
  @@index([createdAt])
  @@index([tokenCurrency, tokenIssuer])
}

model FlagAudit {
  id               String   @id @default(cuid())
  operation        String
  tokenCurrency    String
  tokenIssuer      String
  executor         String
  target           String?
  amount           String?
  network          String
  txHash           String
  sourceIP         String?
  userAgent        String?
  regularKeyUsed   Boolean  @default(false)
  coldWallet       String?
  hotWallet        String?
  hadPermission    Boolean  @default(true)
  permissionReason String?
  metadata         Json     @default("{}")
  createdAt        DateTime @default(now())

  @@index([operation])
  @@index([executor])
  @@index([tokenIssuer])
  @@index([txHash])
  @@index([createdAt])
  @@index([tokenCurrency, tokenIssuer])
}

model IssuerPermission {
  id                           String   @id @default(cuid())
  issuer                       String
  network                      String
  canFreeze                    Boolean  @default(false)
  canClawback                  Boolean  @default(false)
  canAuthorize                 Boolean  @default(true)
  authorizedWallets            String[]
  regularKey                   String?
  coldWallet                   String
  requireColdWalletForFreeze   Boolean  @default(true)
  requireColdWalletForClawback Boolean  @default(true)
  metadata                     Json     @default("{}")
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt

  @@unique([issuer, network])
  @@index([issuer])
  @@index([network])
}

model ServiceWallet {
  id               String             @id @default(cuid())
  label            String
  document         String?
  type             String             @default("issuer")
  network          String             @default("testnet")
  address          String             @unique
  publicKey        String?
  seedEncrypted    String
  isActive         Boolean            @default(false)
  userId           String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  authorizations   MPTAuthorization[]
  distributionMPTs MPTIssuance[]      @relation("DistributionWallet")
  issuedMPTs       MPTIssuance[]      @relation("IssuerWallet")

  @@index([type, isActive])
  @@index([userId])
}

model Purchase {
  id             String        @id @default(cuid())
  purchaseId     String        @unique
  userId         String
  projectId      String?
  amount         Float
  currency       String
  status         String        @default("PENDING")
  mptCurrency    String?
  mptAmount      String?
  mptIssuer      String?
  fundsTxHash    String?       @unique
  mptTxHash      String?
  retryCount     Int           @default(0)
  lastError      String?
  engineResult   String?
  compensationId String?
  actionRequired String?
  lockedAt       DateTime?
  lockedBy       String?
  metadata       Json          @default("{}")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  compensation   Compensation?

  @@index([purchaseId])
  @@index([status])
  @@index([fundsTxHash])
  @@index([mptTxHash])
  @@index([userId])
  @@index([createdAt])
}

model Compensation {
  id             String    @id @default(cuid())
  purchaseId     String    @unique
  type           String
  status         String    @default("PENDING")
  reason         String
  approvedBy     String?
  approvedAt     DateTime?
  executedAt     DateTime?
  refundTxHash   String?
  retryMptTxHash String?
  metadata       Json      @default("{}")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  purchase       Purchase  @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([purchaseId])
}

model CircuitBreakerState {
  id           String    @id @default(cuid())
  endpoint     String    @unique
  state        String    @default("CLOSED")
  failureCount Int       @default(0)
  lastFailure  DateTime?
  openedAt     DateTime?
  nextAttempt  DateTime?
  metadata     Json      @default("{}")
  updatedAt    DateTime  @updatedAt

  @@index([state])
}

model MPTIssuance {
  id                   String             @id @default(cuid())
  type                 String
  symbol               String
  name                 String
  maximumAmount        String
  decimals             Int                @default(0)
  assetScale           Int                @default(0)
  transferFee          Int                @default(0)
  issuerWalletId       String
  distributionWalletId String?
  xrplIssuanceId       String?            @unique
  xrplCurrency         String?
  issuanceTxHash       String?            @unique
  metadataJson         Json               @default("{}")
  flags                Json               @default("{}")
  network              String             @default("testnet")
  status               String             @default("CREATED")
  totalMinted          String             @default("0")
  distributionBalance  String             @default("0")
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  authorizations       MPTAuthorization[]
  distributionWallet   ServiceWallet?     @relation("DistributionWallet", fields: [distributionWalletId], references: [id])
  issuerWallet         ServiceWallet      @relation("IssuerWallet", fields: [issuerWalletId], references: [id])

  @@index([type])
  @@index([symbol])
  @@index([issuerWalletId])
  @@index([distributionWalletId])
  @@index([xrplIssuanceId])
  @@index([status])
  @@index([network])
}

model MPTAuthorization {
  id                     String         @id @default(cuid())
  issuanceId             String
  walletId               String?
  walletAddress          String
  walletType             String
  status                 String         @default("PENDING")
  authorizationTxHash    String?        @unique
  authorizationRequestId String?        @unique
  network                String         @default("testnet")
  metadata               Json           @default("{}")
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  issuance               MPTIssuance    @relation(fields: [issuanceId], references: [id], onDelete: Cascade)
  wallet                 ServiceWallet? @relation(fields: [walletId], references: [id])

  @@unique([issuanceId, walletAddress])
  @@index([issuanceId])
  @@index([walletAddress])
  @@index([walletId])
  @@index([status])
  @@index([authorizationRequestId])
}
